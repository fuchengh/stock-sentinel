name: Investment Sentinel

on:
  schedule:
    # 1. Weekly Strategy: Every Friday at 21:30 UTC (13:30 PT)
    - cron: '30 21 * * 5'
    
    # 2. Daily Watchdog: Monday to Thursday at 21:30 UTC (13:30 PT)
    - cron: '30 21 * * 1-4'

  workflow_dispatch:
    inputs:
      mode:
        description: 'Scan Mode'
        required: true
        default: 'WEEKLY'
        type: choice
        options:
        - WEEKLY
        - DAILY

jobs:
  sentinel-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip' # Enable caching for pip

      - name: Install Dependencies
        run: pip install -r requirements.txt
        
      - name: Determine Mode
        id: mode
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "MODE=${{ inputs.mode }}" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            DAY_OF_WEEK=$(date +%u)
            if [ "$DAY_OF_WEEK" -eq 5 ]; then
              echo "MODE=WEEKLY" >> $GITHUB_ENV
            else
              echo "MODE=DAILY" >> $GITHUB_ENV
            fi
          else
            # Default fallback
            echo "MODE=WEEKLY" >> $GITHUB_ENV
          fi

      - name: Execute Scan
        env:
          ALPACA_KEY: ${{ secrets.ALPACA_KEY }}
          ALPACA_SECRET: ${{ secrets.ALPACA_SECRET }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_USER_ID: ${{ secrets.DISCORD_USER_ID }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ vars.OPENROUTER_MODEL }}
          AI_LANGUAGE: ${{ vars.AI_LANGUAGE }}
          WATCHLIST: ${{ vars.WATCHLIST }}
        run: python -m src.main --mode $MODE
